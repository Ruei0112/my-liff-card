<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†é»å¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col relative border border-gray-100 p-6 text-center">
        
        <div class="flex flex-col items-center mt-4">
            <img id="userAvatar" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full border-4 border-green-400 object-cover" />
            <h1 id="userName" class="mt-4 text-2xl font-bold text-gray-800">è¼‰å…¥ä¸­...</h1>
        </div>

        <div class="flex flex-col items-center py-6">
            <span class="text-sm text-gray-500 font-medium">ç›®å‰é»æ•¸</span>
            <span id="pointsDisplay" class="text-8xl font-black text-green-500">--</span>
            <p class="text-xs text-gray-400 mt-2">æ¯æœˆ 1 è™Ÿè‡ªå‹•é‡ç½®</p>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6 text-left text-sm text-gray-600">
            <p class="font-bold text-yellow-700 mb-1">ğŸ’¡ å¯©æ ¸é€šéæ¢ä»¶ï¼š</p>
            <ul class="list-disc list-inside space-y-1">
                <li>æˆªåœ–å…§å®¹éœ€åŒ…å«é—œéµå­—ï¼šã€Œ<span class="text-red-500 font-bold">æ‰“å¡</span>ã€</li>
            </ul>
        </div>

        <label id="uploadBtn" class="block w-full py-4 px-6 rounded-full text-center font-bold text-white shadow-lg cursor-pointer bg-gray-800 hover:bg-black transition-all active:scale-95">
            <span>ğŸ“¸ ä¸Šå‚³æ‰“å¡æˆªåœ–</span>
            <input type="file" accept="image/*" class="hidden" onchange="handleFileUpload(this)" />
        </label>

        <p id="statusText" class="text-sm text-gray-500 mt-4 h-6"></p>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ è«‹å¡«å…¥å‰›å‰›è¤‡è£½çš„ GAS ç¶²å€ (exec çµå°¾)
        const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwVb14LgVvfsmiYVP2bKMo0UWfZJed4I1q89aSHcAjRx6PIzjbrEq7uBsmmZZj1Ye0H8w/exec"; 

        // ğŸŸ¢ è«‹å¡«å…¥ä½ çš„ LIFF ID
        const MY_LIFF_ID = "2008794893-JBgTcY3w"; 
        // ==========================================

        let currentUserId = "";
        let currentUserName = "æ¸¬è©¦ç”¨æˆ¶";

        async function initApp() {
            try {
                if (MY_LIFF_ID) {
                    await liff.init({ liffId: MY_LIFF_ID });
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        currentUserId = profile.userId;
                        currentUserName = profile.displayName;
                        document.getElementById('userAvatar').src = profile.pictureUrl;
                        document.getElementById('userName').innerText = currentUserName;
                    } else {
                        liff.login();
                        return;
                    }
                } else {
                    // æ¸¬è©¦æ¨¡å¼
                    if(!localStorage.getItem('mockId')) localStorage.setItem('mockId', 'user_' + Math.floor(Math.random()*9999));
                    currentUserId = localStorage.getItem('mockId');
                    document.getElementById('userName').innerText = currentUserName + " (æ¸¬è©¦)";
                }
                fetchPoints();
            } catch (err) {
                alert("åˆå§‹åŒ–éŒ¯èª¤: " + err);
            }
        }

        function fetchPoints() {
            document.getElementById('statusText').innerText = "æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...";
            // ç”±æ–¼ GAS CORS é™åˆ¶ï¼Œé€™è£¡ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ï¼Œä¸»è¦ä¾è³´å¾Œç«¯é‚è¼¯
            // ä½†ç‚ºäº†è®€å–å›å‚³å€¼ï¼Œæˆ‘å€‘ä½¿ç”¨æ¨™æº– POST ä¸¦è™•ç† redirect (fetché è¨­è¡Œç‚º)
            fetch(BACKEND_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getPoints', userId: currentUserId, userName: currentUserName })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('pointsDisplay').innerText = data.points;
                    document.getElementById('statusText').innerText = "è³‡æ–™åŒæ­¥å®Œæˆ";
                }
            })
            .catch(err => { console.error(err); });
        }

        function handleFileUpload(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            
            const btn = document.getElementById('uploadBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="inline-block loader mr-2"></div> AI æ­£åœ¨å¯©æ ¸ä¸­...`;
            btn.style.backgroundColor = "#9CA3AF";
            btn.style.pointerEvents = "none";

            reader.onload = function(e) {
                const base64 = e.target.result;
                fetch(BACKEND_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'verifyImage',
                        userId: currentUserId,
                        userName: currentUserName,
                        imageBase64: base64
                    })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert("ğŸ‰ " + result.message);
                        let nowPoints = parseInt(document.getElementById('pointsDisplay').innerText) || 0;
                        document.getElementById('pointsDisplay').innerText = nowPoints + 1;
                    } else {
                        // é€™è£¡æœƒé¡¯ç¤ºå…·é«”çš„éŒ¯èª¤åŸå› 
                        alert("âŒ å¤±æ•—ï¼š" + result.message);
                    }
                })
                .catch(err => { alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦"); })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = "#1F2937";
                    btn.style.pointerEvents = "auto";
                    input.value = "";
                });
            };
            reader.readAsDataURL(file);
        }
        window.onload = initApp;
    </script>
</body>
</html>
